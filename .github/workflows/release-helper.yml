name: release-helper

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v0.9.5)"
        required: true
        type: string

concurrency:
  group: release-helper
  cancel-in-progress: false

jobs:
  release:
    if: ${{ github.actor == 'ttasovac' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate tag format
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag }}"
          if ! echo "$TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid tag format: $TAG (expected vX.Y.Z)"
            exit 1
          fi
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag already exists: $TAG"
            exit 1
          fi
      - name: Fetch main/dev
        run: |
          set -euo pipefail
          git fetch origin main dev --tags
      - name: Ensure main already contains dev
        run: |
          set -euo pipefail
          if ! git merge-base --is-ancestor origin/dev origin/main; then
            echo "origin/main does not contain origin/dev."
            echo "Run the FF-only dev->main promotion first, then rerun release-helper."
            exit 1
          fi
      - name: Ensure dev CI is clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"
          DEV_SHA="$(git rev-parse origin/dev)"
          RUNS_URL="https://api.github.com/repos/${REPO}/actions/workflows/site-build.yml/runs?branch=dev&event=push&per_page=5"
          json="$(curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "$RUNS_URL")"
          busy="$(printf '%s' "$json" | python3 - <<'PY'\nimport json,sys\nj=json.load(sys.stdin)\nfor r in j.get('workflow_runs',[]):\n    if r.get('status') in ('queued','in_progress'):\n        print(r.get('html_url',''))\n        break\nPY\n)"
          if [ -n "$busy" ]; then
            echo "dev CI is still running: $busy"
            exit 1
          fi
          match="$(printf '%s' "$json" | python3 - <<'PY'\nimport json,sys\nj=json.load(sys.stdin)\nsha=sys.argv[1]\nfor r in j.get('workflow_runs',[]):\n    if r.get('head_sha') == sha:\n        print(f\"{r.get('status','')}|{r.get('conclusion','')}|{r.get('html_url','')}\")\n        break\nPY\n\"$DEV_SHA\")"
          if [ -z "$match" ]; then
            echo "No site-build run found for dev SHA $DEV_SHA."
            exit 1
          fi
          status="$(printf '%s' "$match" | cut -d'|' -f1)"
          conclusion="$(printf '%s' "$match" | cut -d'|' -f2)"
          url="$(printf '%s' "$match" | cut -d'|' -f3)"
          if [ "$status" != "completed" ] || [ "$conclusion" != "success" ]; then
            echo "Latest dev CI for $DEV_SHA is not successful (status=$status, conclusion=$conclusion)."
            if [ -n "$url" ]; then
              echo "Run: $url"
            fi
            exit 1
          fi
      - name: Ensure release metadata already exists on main
        run: |
          set -euo pipefail
          git checkout -B main origin/main
          if [ ! -f CITATION.cff ]; then
            echo "CITATION.cff missing on origin/main."
            exit 1
          fi
          if ! grep -Eq '^date-released:[[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}$' CITATION.cff; then
            echo "CITATION.cff on origin/main must include 'date-released: YYYY-MM-DD' before tagging."
            echo "Prepare citation metadata on dev first, then fast-forward main to dev."
            exit 1
          fi
      - name: Create annotated tag
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag }}"
          git fetch origin main --tags
          git checkout -B main origin/main
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            echo "Tag already exists after validation stage: $TAG"
            exit 1
          fi
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
