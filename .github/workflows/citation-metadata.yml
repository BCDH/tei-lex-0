name: citation-metadata

on:
  push:
    branches: [main, dev]

concurrency:
  group: citation-metadata-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update_citation:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
      - name: Cache Calabash, Saxon, and Maven
        uses: actions/cache@v4
        with:
          path: |
            .cache/tools
            ~/.m2/repository
          key: calabash-3.0.35-saxon-12.4-maven
      - name: Prepare Calabash and Saxon
        run: |
          set -euo pipefail
          mkdir -p .cache/tools
          CALABASH_VERSION=3.0.35
          SAXON_VERSION=12.4
          SAXON_JAR=".cache/tools/saxon-he-${SAXON_VERSION}.jar"
          cat > .cache/tools/pom.xml <<'EOF_POM'
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>
            <groupId>local</groupId>
            <artifactId>calabash-runner</artifactId>
            <version>1.0.0</version>
            <dependencies>
              <dependency>
                <groupId>com.xmlcalabash</groupId>
                <artifactId>app</artifactId>
                <version>3.0.35</version>
              </dependency>
            </dependencies>
          </project>
          EOF_POM
          OUTPUT_FILE="$(pwd)/.cache/tools/classpath.txt"
          if ! mvn -q -B -f .cache/tools/pom.xml -DincludeScope=runtime -Dmdep.outputFile="$OUTPUT_FILE" \
            org.apache.maven.plugins:maven-dependency-plugin:3.6.1:build-classpath > .cache/tools/maven.log 2>&1; then
            echo "Maven failed while building Calabash classpath."
            tail -n 200 .cache/tools/maven.log || true
            exit 1
          fi
          if [ ! -s "$OUTPUT_FILE" ]; then
            echo "Calabash classpath not generated."
            tail -n 200 .cache/tools/maven.log || true
            exit 1
          fi
          echo "Calabash classpath ready."
          if [ ! -f "$SAXON_JAR" ]; then
            curl -fL -o "$SAXON_JAR" "https://repo.maven.apache.org/maven2/net/sf/saxon/Saxon-HE/${SAXON_VERSION}/Saxon-HE-${SAXON_VERSION}.jar"
            curl -fL -o "$SAXON_JAR.sha256" "https://repo.maven.apache.org/maven2/net/sf/saxon/Saxon-HE/${SAXON_VERSION}/Saxon-HE-${SAXON_VERSION}.jar.sha256"
            EXPECTED="$(tr -d ' \n' < "$SAXON_JAR.sha256")"
            if ! echo "$EXPECTED" | grep -Eq '^[0-9a-fA-F]{64}$'; then
              echo "Invalid Saxon checksum: $EXPECTED"
              exit 1
            fi
            echo "$EXPECTED  $SAXON_JAR" | sha256sum -c -
          fi
          echo "Saxon jar ready."
          CALABASH_CP="$(cat "$OUTPUT_FILE")"
          echo "XMLCALABASH_CMD=java -cp \"$CALABASH_CP\" com.xmlcalabash.app.Main {PIPELINE}" >> "$GITHUB_ENV"
          echo "SAXON_JAR=$SAXON_JAR" >> "$GITHUB_ENV"
      - run: node scripts/run-citation-cff.mjs
      - name: Inject citation metadata
        run: |
          set -euo pipefail
          node scripts/update-citation-metadata.mjs \
            --commit "${GITHUB_SHA}" \
            --date "$(date -u +%F)"
      - name: Create or update metadata PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if git diff --quiet -- CITATION.cff; then
            echo "No citation metadata changes."
            exit 0
          fi
          BRANCH="ci/citation-metadata/${GITHUB_REF_NAME}"
          BASE="${GITHUB_REF_NAME}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          STASHED=0
          if [ -n "$(git status --porcelain CITATION.cff)" ]; then
            git stash push -u -m "citation-metadata" -- CITATION.cff
            STASHED=1
          fi
          git fetch origin "$BRANCH" || true
          if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
            git checkout -B "$BRANCH" "origin/$BRANCH"
          else
            git checkout -B "$BRANCH"
          fi
          if [ "$STASHED" = "1" ]; then
            git stash pop
          fi
          git add CITATION.cff
          git commit -m "chore: update citation metadata"
          git push --force-with-lease -u origin "$BRANCH"
          PR_NUMBER="$(gh pr list --head "$BRANCH" --base "$BASE" --json number --jq '.[0].number')"
          # Ensure label exists (best-effort; do not fail if we can't create it).
          gh label create "automation" --color "0E8A16" --description "Automated changes" --force >/dev/null 2>&1 || true
          if [ -z "$PR_NUMBER" ]; then
            PR_URL="$(gh pr create --base "$BASE" --head "$BRANCH" --title "chore: update citation metadata" --body "Automated metadata update for CITATION.cff." --label "automation" || gh pr create --base "$BASE" --head "$BRANCH" --title "chore: update citation metadata" --body "Automated metadata update for CITATION.cff.")"
            PR_NUMBER="$(echo "$PR_URL" | sed -E 's#.*/pull/([0-9]+).*#\\1#')"
          else
            gh pr edit "$PR_NUMBER" --title "chore: update citation metadata" --body "Automated metadata update for CITATION.cff." --add-label "automation" || \
              gh pr edit "$PR_NUMBER" --title "chore: update citation metadata" --body "Automated metadata update for CITATION.cff."
          fi
          gh pr merge "$PR_NUMBER" --rebase --auto
